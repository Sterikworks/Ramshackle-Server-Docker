services:
  ramshackle:
    build:
      context: https://github.com/Sterikworks/Ramshackle-Server-Docker.git
      dockerfile: Dockerfile
    container_name: ramshackle-server
    restart: unless-stopped

    ports:
      - "4999-5010:4999-5010/udp"   # lobby + battle-room port range (UDP)
      - "4999-5010:4999-5010/tcp"   # lobby + battle-room port range (TCP)
      # the game's lobby sits on {port}, steam broadcasts on {port -1}, each battleroom is {port +1,2,3..etc}

    volumes:
      - ./data/server:/srv/ramshackle/server
      - ./data/steamcmd:/srv/ramshackle/steamcmd
      - ./data/saves:/home/steam/.config/Mountainous Development/REMProject

    environment:
      # === STEAM CREDENTIALS ===
      # SteamCMD will use anonymous login by default. If you need to use a
      # real account (not recommended for automation), override these.
      - STEAM_USER=anonymous
      - STEAM_PASS=
      - STEAM_GUARD=

      # === WORLD SETTINGS (REQUIRED) ===
      - SCENARIO=MyWorld                    # REQUIRED: change this to your world name!

      # === SERVER BRANCH ===
      - BRANCH=development                  # "default" or "development" (steam branches)
      - BRANCH_PASSWORD=                    # password if branch requires it

      # === OPTIONAL SETTINGS ===
      - MANIFEST_ID=                        # pin to specific version (leave empty for latest)
      - EXTRA_ARGS=-batchmode -nographics -debug -lobby -end  # server launch arguments
      - SERVER_BIN=/srv/ramshackle/server/REMProject.x86_64   # run binary directly, bypass start script

      # === FILE OWNERSHIP (Linux/Mac) ===
      - PUID=1000                           # idk what this does it just makes linux shut up
      - PGID=1000                           #

      # === ADVANCED ===
      - RETRIES=3                           # retry attempts for Steam downloads
      - RETRY_SLEEP=10                      # seconds between retries
      # === AUTO-UPDATE ===
      # If true, the container will run `app_update ${APP_ID} validate` on each container start.
      # Set to false to disable automatic updates at container startup.
      - AUTO_UPDATE=true

      # === FIXED VALUES (rarely change) ===
      - APP_ID=4021040
      - DEPOT_ID=4021043
      - PLATFORM=linux
      - BITNESS=64

    # Healthcheck kept but made intentionally conservative to avoid frequent container
    # restarts which can cause repeated steamcmd logins during startup.
    # If you want to disable the healthcheck entirely, set this to 'none' or remove
    # the block below.
    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck.sh"]
      # Long interval reduces chance of repeated restart loops / login spam.
      interval: 5m
      # Allow more time for server to respond during cold starts.
      timeout: 30s
      # On user request, use only 1 retry so external watchers/alerts trigger quickly.
      retries: 1
